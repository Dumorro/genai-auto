name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: "3.11"

jobs:
  quick-check:
    name: âš¡ Quick PR Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diffs

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install tools
        run: |
          pip install ruff black mypy pytest

      - name: Run Ruff (fast)
        run: |
          ruff check src/ tests/ --output-format=github

      - name: Run Black (fast)
        run: |
          black --check src/ tests/

      - name: Check file sizes
        run: |
          echo "Checking for large files..."
          find . -type f -size +5M -not -path "./node_modules/*" -not -path "./.git/*" || echo "No large files"

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets..."
          ! grep -rE "(password|secret|key|token)\s*=\s*['\"][^'\"]{10,}" src/ || \
            (echo "âš ï¸ Potential hardcoded secret found" && exit 1)

      - name: PR size check
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo 0)
          echo "ðŸ“Š Files changed: $FILES_CHANGED"
          echo "ðŸ“Š Lines changed: $LINES_CHANGED"
          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "âš ï¸ Large PR: $FILES_CHANGED files changed"
          fi
          if [ "$LINES_CHANGED" -gt 500 ]; then
            echo "âš ï¸ Large PR: $LINES_CHANGED lines changed"
          fi

      - name: Generate PR summary
        run: |
          echo "## ðŸ“ PR Quick Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatting (black)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linting (ruff)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No large files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No hardcoded secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full CI will run automatically." >> $GITHUB_STEP_SUMMARY

  comment:
    name: ðŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: quick-check
    if: always()
    
    steps:
      - name: Add PR comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'ðŸ‘‹ Thanks for your PR! Quick checks passed. Full CI is running now.'
            })
